on:
  workflow_call:
    inputs:
      skip-test:
        type: string
        default: 'false'
        description: "Should the tests be ran"
      skip-test-publish:
        type: string
        default: 'false'
        description: "Should the publis dry-run test be ran"
      publish:
        type: string
        default: 'false'
        description: "Should the crate be published"
      publish_private_registry:
        type: string
        default: 'false'
        description: "Should the crate be published to the private registry"
      publish_public_registry:
        type: string
        default: 'false'
        description: "Should the crate be published to the public registry"
      publish_docker:
        type: string
        default: 'false'
        description: "Should the docker image be built and published"
      publish_binary:
        type: string
        default: 'false'
        description: "Should the binary be built and published"
      toolchain:
        type: string
        default: "1.69"
        description: Rust toolchain to install
      release_channel:
        type: string
        default: ""
        description: Hard coded release channel
      additional_cache_path:
        type: string
        default: ""
        description: Path of additional cache to get
      additional_cache_key:
        type: string
        default: ""
        description: Key of additional cache to get
      additional_cache_miss:
        type: string
        default: ""
        description: Script to run if additional cache miss
      additional_script:
        type: string
        default: ""
        description: Additional script to run before the additional packages
      required_packages:
        type: string
        default: ""
        description: Package that needs to be installed before Rust compilation can happens
      working-directory:
        type: string
        default: "."
        description: Working directory to run the cargo command
      additional_args:
        type: string
        default: ""
        description: Additional arguments to pass to the cargo command
      custom_cargo_commands:
        type: string
        default: ""
        description: Cusom cargo commands that will be run after login
      dockerfile:
        type: string
        description: "The path to the Dockerfile to use"
        default: Dockerfile
      docker_image:
        type: string
        default: ''
        description: "Docker image name"
      docker_registry:
        type: string
        default: "oreprohub.azurecr.io"
        description: "Docker registry"
      matrix_file:
        type: string
        default: '.github/workflows/matrix.json'
        description: "Matrix file to load"
      post_build_additional_script:
        type: string
        default: ""
        description: Post Build Additional script to run after the additional packages

jobs:
  test:
    uses: ForesightMiningSoftwareCorporation/github/.github/workflows/rust-test.yml@v1.1.0
    if: ${{ inputs.skip-test != 'true' }}
    with:
      toolchain: ${{ inputs.toolchain }}
      additional_cache_path: ${{ inputs.additional_cache_path }}
      additional_cache_key: ${{ inputs.additional_cache_key }}
      additional_cache_miss: ${{ inputs.additional_cache_miss }}
      additional_script: ${{ inputs.additional_script }}
      required_packages: ${{ inputs.required_packages }}
      working-directory: ${{ inputs.working-directory }}
      additional_args: ${{ inputs.additional_args }}
      custom_cargo_commands: ${{ inputs.custom_cargo_commands }}
      login_private_registry: ${{ inputs.publish_public_registry != 'true' }}
      skip-test-publish: ${{ inputs.skip-test-publish }}
    secrets: inherit
  publish_private_registry:
    uses: ForesightMiningSoftwareCorporation/github/.github/workflows/rust_private_registry_publish.yml@v1.1.0
    if: always() && inputs.publish == 'true' && inputs.publish_private_registry == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    needs:
      - test
    with:
      toolchain: ${{ inputs.toolchain }}
      additional_script: ${{ inputs.additional_script }}
      required_packages: ${{ inputs.required_packages }}
      working-directory: ${{ inputs.working-directory }}
      additional_args: ${{ inputs.additional_args }}
      custom_cargo_commands: ${{ inputs.custom_cargo_commands }}
    secrets: inherit
  publish_public_registry:
    uses: ForesightMiningSoftwareCorporation/github/.github/workflows/rust_public_registry_publish.yml@v1.1.0
    if: always() && inputs.publish == 'true' && inputs.publish_public_registry == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    needs:
      - test
    with:
      toolchain: ${{ inputs.toolchain }}
      additional_script: ${{ inputs.additional_script }}
      required_packages: ${{ inputs.required_packages }}
      working-directory: ${{ inputs.working-directory }}
      additional_args: ${{ inputs.additional_args }}
      custom_cargo_commands: ${{ inputs.custom_cargo_commands }}
    secrets: inherit
  publish_docker:
    uses: ForesightMiningSoftwareCorporation/github/.github/workflows/docker_publish.yml@v1.1.0
    if: always() && inputs.publish == 'true' && inputs.publish_docker == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    needs:
      - test
    with:
      working-directory: ${{ inputs.working-directory }}
      dockerfile: ${{ inputs.dockerfile }}
      image: ${{ inputs.docker_image }}
      registry: ${{ inputs.docker_registry }}
    secrets: inherit
  publish_binary:
    uses: ForesightMiningSoftwareCorporation/github/.github/workflows/rust_binary_publish.yml@v1.1.0
    if: always() && inputs.publish == 'true' && inputs.publish_binary == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    needs:
      - test
    with:
      toolchain: ${{ inputs.toolchain }}
      release_channel: ${{ inputs.release_channel }}
      additional_script: ${{ inputs.additional_script }}
      required_packages: ${{ inputs.required_packages }}
      working-directory: ${{ inputs.working-directory }}
      additional_args: ${{ inputs.additional_args }}
      custom_cargo_commands: ${{ inputs.custom_cargo_commands }}
      matrix_file: ${{ inputs.matrix_file }}
      post_build_additional_script: ${{ inputs.post_build_additional_script }}
    secrets: inherit
  report_release:
    needs:
      - publish_private_registry
      - publish_public_registry
      - publish_docker
      - publish_binary
    uses: ForesightMiningSoftwareCorporation/github/.github/workflows/gh-release-when-published.yaml@v1.1.0
    if: always() && inputs.publish == 'true' && ( inputs.publish_private_registry == 'false' || (inputs.publish_private_registry == 'true' && needs.publish_private_registry.outputs.released == 'true' )) && ( inputs.publish_public_registry == 'false' || ( inputs.publish_public_registry == 'true' && needs.publish_public_registry.outputs.released == 'true' ))  && (inputs.publish_docker == 'false' || ( inputs.publish_docker == 'true' && needs.publish_docker.outputs.released == 'true' )) && (inputs.publish_binary == 'false' || inputs.publish_binary == 'true' )
    with:
      working-directory: ${{ inputs.working-directory }}
      private_registry_release: ${{ inputs.publish_private_registry == 'true' && needs.publish_private_registry.outputs.released == 'true' }}
      public_registry_release: ${{ inputs.publish_public_registry == 'true' && needs.publish_public_registry.outputs.released == 'true' }}
      docker_release: ${{ inputs.publish_docker == 'true' && needs.publish_docker.outputs.released == 'true' }}
      binary_release: ${{ inputs.publish_binary == 'true' && needs.publish_binary.outputs.released == 'true' }}
    secrets: inherit
