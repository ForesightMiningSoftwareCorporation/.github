name: "Run shell script and get the stdout and stderr as outputs"
description: "Composite action to run shell script with stdout"

inputs:
  command:
    required: true
    description: "The command"
  working-directory:
    required: true
    description: "The working directory"
  loki_url:
    required: true
    description: "URL to contact loki"
  loki_org_id:
    required: true
    description: "Loki Org Id"
  loki_username:
    required: true
    description: "Username to talk to loki"
  loki_password:
    required: true
    description: "Password to talk to loki"
outputs:
  stdout:
    description: "Command STDOUT"
    value: ${{ steps.command.outputs.stdout }}
  stderr:
    description: "Command STDERR"
    value: ${{ steps.command.outputs.stderr }}
  exitcode:
    description: "Command exitcode"
    value: ${{ steps.command.outputs.exitcode }}
runs:
  using: "composite"
  steps:
    - name: Run Command
      shell: bash
      id: command
      continue-on-error: true
      working-directory: ${{ inputs.working-directory }}
      run: |
        if ${{ inputs.command }} 2>&1 | ts "%Y-%m-%dT%H:%M:%.SZ; " | tee output.txt; then
          rc=0
        else
          rc=$?
        fi
        echo "exitcode=$rc" >> $GITHUB_OUTPUT
    - name: Check exit code
      shell: bash
      run: |
        echo "Command exited with code ${{ steps.command.outputs.exitcode }}"
        exit ${{ steps.command.outputs.exitcode }}
